# -*- coding: utf-8 -*-
"""Untitled0.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1HinhhkwNY9YQtEh9ZfEoTEDCJPB2a6Pi

# New Section
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from datetime import datetime, timedelta

class EnhancedVolatilityMomentumStrategy:
    def __init__(self, formation_period=60, volatility_growth_threshold=1.5,
                 min_volatility_ratio=2.0, entry_threshold=0.003):
        self.formation_period = formation_period  # –ü–µ—Ä–∏–æ–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è (3 –º–µ—Å—è—Ü–∞)
        self.volatility_growth_threshold = volatility_growth_threshold  # –†–æ—Å—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ > 50%
        self.min_volatility_ratio = min_volatility_ratio  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–µ–π
        self.entry_threshold = entry_threshold  # 0.3% –¥–ª—è –≤—Ö–æ–¥–∞
        self.last_volatility_ratio = None

    def calculate_volatility(self, returns, window=20):
        """–†–∞—Å—á–µ—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏"""
        return returns.rolling(window=window).std() * np.sqrt(252)

    def analyze_volatility_regime(self, prices):
        """–ê–Ω–∞–ª–∏–∑ —Ä–µ–∂–∏–º–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏"""
        returns = np.log(prices / prices.shift(1))

        # –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è vs –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
        vol_short = self.calculate_volatility(returns, window=10)
        vol_long = self.calculate_volatility(returns, window=20)

        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
        volatility_trend = vol_short / vol_long

        return {
            'volatility_trend': volatility_trend,
            'is_volatility_growing': volatility_trend.iloc[-1] > self.volatility_growth_threshold,
            'volatility_momentum': (vol_short.iloc[-1] - vol_long.iloc[-1]) / vol_long.iloc[-1]
        }

    def prepare_trading_day(self, prices_numerator, prices_denominator):
        """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ç–æ—Ä–≥–æ–≤–æ–º—É –¥–Ω—é - —ç—Ç–∞–ø 1"""
        returns_num = np.log(prices_numerator / prices_numerator.shift(1))
        returns_den = np.log(prices_denominator / prices_denominator.shift(1))

        # –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –∑–∞ formation –ø–µ—Ä–∏–æ–¥
        vol_num = self.calculate_volatility(returns_num.tail(self.formation_period))
        vol_den = self.calculate_volatility(returns_den.tail(self.formation_period))

        # –ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è
        correlation = returns_num.tail(self.formation_period).corr(returns_den.tail(self.formation_period))

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
        current_vol_ratio = vol_num.iloc[-1] / vol_den.iloc[-1]
        self.last_volatility_ratio = current_vol_ratio

        # –ê–Ω–∞–ª–∏–∑ —Ä–µ–∂–∏–º–æ–≤ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
        vol_regime_num = self.analyze_volatility_regime(prices_numerator.tail(self.formation_period))
        vol_regime_den = self.analyze_volatility_regime(prices_denominator.tail(self.formation_period))

        return {
            'volatility_ratio': current_vol_ratio,
            'correlation': correlation,
            'vol_regime_num': vol_regime_num,
            'vol_regime_den': vol_regime_den,
            'passes_screening': (
                abs(correlation) > 0.7 and
                current_vol_ratio >= self.min_volatility_ratio and
                (vol_regime_num['is_volatility_growing'] or vol_regime_den['is_volatility_growing'])
            )
        }

    def execute_trading(self, prices_numerator, prices_denominator, analysis_data):
        """–≠—Ç–∞–ø 2 - –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–∏"""
        if not analysis_data['passes_screening']:
            return None, "–ù–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–∫—Ä–∏–Ω–∏–Ω–≥"

        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
        if self.last_volatility_ratio > 1:
            # numerator –±–æ–ª–µ–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω—ã–π
            adjusted_denominator = prices_denominator * self.last_volatility_ratio
            adjusted_numerator = prices_numerator
            vol_priority = 'numerator'
        else:
            # denominator –±–æ–ª–µ–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω—ã–π
            adjusted_numerator = prices_numerator / self.last_volatility_ratio
            adjusted_denominator = prices_denominator
            vol_priority = 'denominator'

        # –ê–Ω–∞–ª–∏–∑ –¥–≤–∏–∂–µ–Ω–∏—è —Å –Ω–∞—á–∞–ª–∞ –¥–Ω—è
        today_mask = prices_numerator.index >= prices_numerator.index[-1].normalize()
        today_prices_num = adjusted_numerator[today_mask]
        today_prices_den = adjusted_denominator[today_mask]

        if len(today_prices_num) < 2:
            return None, "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Å–µ–≥–æ–¥–Ω—è"

        # –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ (–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω–æ–µ –æ—Ç —É—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è)
        move_num = (today_prices_num.iloc[-1] / today_prices_num.iloc[0]) - 1
        move_den = (today_prices_den.iloc[-1] / today_prices_den.iloc[0]) - 1
        relative_move = move_num - move_den

        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
        signal = None
        rationale = ""

        if abs(relative_move) >= self.entry_threshold:
            if vol_priority == 'numerator':
                if relative_move > 0:
                    signal = 'BUY_NUMERATOR_SELL_DENOMINATOR'
                    rationale = f"–í–æ–ª–∞—Ç–∏–ª—å–Ω—ã–π –∞–∫—Ç–∏–≤ —Ä–∞—Å—Ç–µ—Ç –±—ã—Å—Ç—Ä–µ–µ: +{relative_move:.3%}"
                else:
                    signal = 'SELL_NUMERATOR_BUY_DENOMINATOR'
                    rationale = f"–í–æ–ª–∞—Ç–∏–ª—å–Ω—ã–π –∞–∫—Ç–∏–≤ –ø–∞–¥–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ: {relative_move:.3%}"
            else:
                if relative_move > 0:
                    signal = 'SELL_NUMERATOR_BUY_DENOMINATOR'
                    rationale = f"–ú–µ–Ω–µ–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω—ã–π –∞–∫—Ç–∏–≤ –æ—Ç—Å—Ç–∞–µ—Ç: +{relative_move:.3%}"
                else:
                    signal = 'BUY_NUMERATOR_SELL_DENOMINATOR'
                    rationale = f"–ú–µ–Ω–µ–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω—ã–π –∞–∫—Ç–∏–≤ —É—Å—Ç–æ–π—á–∏–≤–µ–µ: {relative_move:.3%}"

        return signal, {
            'signal': signal,
            'relative_move': relative_move,
            'vol_priority': vol_priority,
            'volatility_ratio': analysis_data['volatility_ratio'],
            'rationale': rationale,
            'move_breakdown': {'numerator': move_num, 'denominator': move_den}
        }

# –°–ò–ú–£–õ–Ø–¶–ò–Ø –†–ï–ê–õ–ò–°–¢–ò–ß–ù–û–ì–û –°–¶–ï–ù–ê–†–ò–Ø
def simulate_volatility_expansion_scenario():
    """–°–∏–º—É–ª—è—Ü–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏"""
    np.random.seed(42)
    n_days = 100
    dates = pd.date_range('2024-06-01', periods=n_days, freq='D')

    # –ë–∞–∑–æ–≤—ã–π —Ç—Ä–µ–Ω–¥ (–æ–±—â–∏–π –¥–ª—è –æ–±–æ–∏—Ö –∞–∫—Ç–∏–≤–æ–≤)
    base_trend = np.cumsum(np.random.normal(0.0005, 0.005, n_days))

    # –ê–∫—Ç–∏–≤ A (–±—É–¥—É—â–∏–π high-vol) - –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
    volatility_regime_change = 50  # –¥–µ–Ω—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞

    # –§–æ–Ω–æ–≤–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
    noise_A = np.random.normal(0, 0.015, n_days)
    noise_B = np.random.normal(0, 0.008, n_days)

    # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–ø–ª–µ—Å–∫ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞ A
    for i in range(volatility_regime_change, n_days):
        if i % 3 == 0:  # –ò–º–ø—É–ª—å—Å–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è
            noise_A[i] += np.random.normal(0, 0.03)

    prices_A = 100 * np.exp(base_trend + np.cumsum(noise_A))
    prices_B = 100 * np.exp(base_trend + np.cumsum(noise_B))

    return pd.DataFrame({'Asset_A': prices_A, 'Asset_B': prices_B}, index=dates)

# –í–ê–õ–ò–î–ê–¶–ò–Ø –°–¢–†–ê–¢–ï–ì–ò–ò
def validate_enhanced_strategy():
    print("üîí –£–°–û–í–ï–†–®–ï–ù–°–¢–í–û–í–ê–ù–ù–´–ô –ê–ù–ê–õ–ò–ó –°–¢–†–ê–¢–ï–ì–ò–ò")
    print("=" * 65)

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    data = simulate_volatility_expansion_scenario()

    strategy = EnhancedVolatilityMomentumStrategy(
        formation_period=60,
        volatility_growth_threshold=1.5,
        min_volatility_ratio=2.0,
        entry_threshold=0.003
    )

    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö
    test_prices_num = data['Asset_A']
    test_prices_den = data['Asset_B']

    # –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    analysis = strategy.prepare_trading_day(test_prices_num, test_prices_den)

    print("üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –°–ö–†–ò–ù–ò–ù–ì–ê (–≠—Ç–∞–ø 1):")
    print(f"–û—Ç–Ω–æ—à–µ–Ω–∏–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–µ–π: {analysis['volatility_ratio']:.2f}")
    print(f"–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è: {analysis['correlation']:.3f}")
    print(f"–†–æ—Å—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ Numerator: {analysis['vol_regime_num']['is_volatility_growing']}")
    print(f"–†–æ—Å—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ Denominator: {analysis['vol_regime_den']['is_volatility_growing']}")
    print(f"–ü—Ä–æ—Ö–æ–¥–∏—Ç —Å–∫—Ä–∏–Ω–∏–Ω–≥: {analysis['passes_screening']}")

    if analysis['passes_screening']:
        # –≠—Ç–∞–ø 2: –¢–æ—Ä–≥–æ–≤–ª—è
        signal, details = strategy.execute_trading(test_prices_num, test_prices_den, analysis)

        print(f"\nüéØ –¢–û–†–ì–û–í–´–ô –°–ò–ì–ù–ê–õ (–≠—Ç–∞–ø 2):")
        print(f"–°–∏–≥–Ω–∞–ª: {signal}")
        print(f"–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: {details['rationale']}")
        print(f"–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ: {details['relative_move']:.3%}")
        print(f"–î–≤–∏–∂–µ–Ω–∏–µ Numerator: {details['move_breakdown']['numerator']:.3%}")
        print(f"–î–≤–∏–∂–µ–Ω–∏–µ Denominator: {details['move_breakdown']['denominator']:.3%}")

        # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
        plt.figure(figsize=(15, 10))

        # –ì—Ä–∞—Ñ–∏–∫ 1: –ò—Å—Ö–æ–¥–Ω—ã–µ —Ü–µ–Ω—ã
        plt.subplot(3, 1, 1)
        plt.plot(data.index, data['Asset_A']/data['Asset_A'].iloc[0], label='Asset A (High Vol)', linewidth=2)
        plt.plot(data.index, data['Asset_B']/data['Asset_B'].iloc[0], label='Asset B (Low Vol)', linewidth=2)
        plt.title('–ò—Å—Ö–æ–¥–Ω—ã–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã')
        plt.legend()
        plt.grid(True, alpha=0.3)

        # –ì—Ä–∞—Ñ–∏–∫ 2: –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—ã–µ –æ—Ç —É—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è —Ü–µ–Ω—ã
        plt.subplot(3, 1, 2)
        if strategy.last_volatility_ratio > 1:
            adjusted_B = data['Asset_B'] * strategy.last_volatility_ratio
            plt.plot(data.index, data['Asset_A']/data['Asset_A'].iloc[0], label='Asset A (–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è)', linewidth=2)
            plt.plot(data.index, adjusted_B/adjusted_B.iloc[0], label='Asset B (–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—ã–π)', linewidth=2)
        else:
            adjusted_A = data['Asset_A'] / strategy.last_volatility_ratio
            plt.plot(data.index, adjusted_A/adjusted_A.iloc[0], label='Asset A (–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—ã–π)', linewidth=2)
            plt.plot(data.index, data['Asset_B']/data['Asset_B'].iloc[0], label='Asset B (–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è)', linewidth=2)
        plt.title('–¶–µ–Ω—ã –ø–æ—Å–ª–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –æ—Ç —É—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏')
        plt.legend()
        plt.grid(True, alpha=0.3)

        # –ì—Ä–∞—Ñ–∏–∫ 3: –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
        plt.subplot(3, 1, 3)
        relative_performance = (data['Asset_A']/data['Asset_A'].iloc[0]) / (data['Asset_B']/data['Asset_B'].iloc[0])
        plt.plot(data.index, relative_performance, label='–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å A/B', color='red', linewidth=2)
        plt.axhline(y=1, color='black', linestyle='--', alpha=0.5)
        plt.title('–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (A/B)')
        plt.legend()
        plt.grid(True, alpha=0.3)

        plt.tight_layout()
        plt.show()

        return signal, details

    return None, analysis

# –ó–ê–ü–£–°–ö
if __name__ == "__main__":
    signal, details = validate_enhanced_strategy()